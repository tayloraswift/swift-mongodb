#!/bin/bash

ANY_FAILED=0
SWIFT_FLAGS="-Xcc -mcx16 -Xswiftc -DENABLE_DOUBLEWIDE_ATOMICS"

swift --version

swift build -c release $SWIFT_FLAGS --target BSONSchema ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          BSONTests ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          BSONDecodingTests ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          BSONEncodingTests ||
    ANY_FAILED=1


swift build -c release $SWIFT_FLAGS --target Heartbeats ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          HeartbeatsTests ||
    ANY_FAILED=1


swift build -c release $SWIFT_FLAGS --target MongoDriver ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          MongoDriverTests ||
    ANY_FAILED=1


swift build -c release $SWIFT_FLAGS --target MongoDB ||
    ANY_FAILED=1

swift run   -c release $SWIFT_FLAGS          MongoDBTests ||
    ANY_FAILED=1

if [ "$ANY_FAILED" -ne 0 ] ; then
    exit
fi
